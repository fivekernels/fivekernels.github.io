<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Nextcloud With Docker | 胡写乱画</title>
<meta name="keywords" content="nextcloud, docker">
<meta name="description" content="本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onl">
<meta name="author" content="hey">
<link rel="canonical" href="https://fivekernels.github.io/posts/nextcloud-with-docker/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.193f5e1cb1ec7f5edeaea1140916a7023d6d6c087917077bf463fe5ee3727903.css" integrity="sha256-GT9eHLHsf17erqEUCRanAj1tbAh5Fwd79GP&#43;XuNyeQM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fivekernels.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://fivekernels.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://fivekernels.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://fivekernels.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://fivekernels.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Nextcloud With Docker" />
<meta property="og:description" content="本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onl" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fivekernels.github.io/posts/nextcloud-with-docker/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-20T11:05:07+08:00" />
<meta property="article:modified_time" content="2022-12-20T11:05:07+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nextcloud With Docker"/>
<meta name="twitter:description" content="本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onl"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "https://fivekernels.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Nextcloud With Docker",
      "item": "https://fivekernels.github.io/posts/nextcloud-with-docker/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nextcloud With Docker",
  "name": "Nextcloud With Docker",
  "description": "本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onl",
  "keywords": [
    "nextcloud", "docker"
  ],
  "articleBody": " 本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onlyoffice。\nNextcloud官方手册中有数据库等各种镜像版本推荐https://docs.nextcloud.com/server/latest/admin_manual/installation/system_requirements.html，最好不要使用过于新的版本以免出现未被解决的兼容性问题。\nNextcloud版本介绍：\nnextcloud:latest：默认最新版本，新手友好。使用debian容器搭建，自带apache web服务，特点就是简单方便，一键部署就可以使用，缺点就是包略大。 nextcloud:fpm：在debian容器的基础上不带apache web服务，需要配套web程序才能使用，如NGINX。 nextcloud:-alpine：使用alpine作为容器，空间占据少，适合小主机使用。 docker-compose docker-compose.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 version: '3' services: nextcloud: hostname: nextcloud image: nextcloud:fpm container_name: nextcloud_nextcloud restart: unless-stopped volumes: - ./PersistentData/nextcloud:/var/www/html env_file: - ./nextcloud.env depends_on: - mariadb - redis mariadb: hostname: mariadb image: mariadb container_name: nextcloud_mariadb restart: unless-stopped command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --transaction-isolation=READ-COMMITTED --binlog-format=ROW --innodb_read_only_compressed=OFF volumes: - ./PersistentData/mariadb:/var/lib/mysql env_file: - ./mariadb.env nginx: hostname: nginx image: nginx container_name: nextcloud_nginx restart: unless-stopped volumes: - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro - ./config/ssl//fullchain.pem:/etc/ssl/nginx/fullchain.pem - ./config/ssl//privkey.pem:/etc/ssl/nginx/privkey.pem - ./PersistentData/nextcloud:/usr/share/nginx/html/nextcloud:ro ports: - \"80:80\" - \"443:443\" depends_on: - nextcloud redis: image: redis container_name: nextcloud_redis restart: unless-stopped cron: image: nextcloud:fpm container_name: nextcloud_cron restart: unless-stopped volumes: - ./PersistentData/nextcloud:/var/www/html entrypoint: /cron.sh depends_on: - mariadb - redis nextcloud.env 1 2 3 4 5 6 7 8 9 10 11 NEXTCLOUD_ADMIN_USER= NEXTCLOUD_ADMIN_PASSWORD= NEXTCLOUD_TRUSTED_DOMAINS= MYSQL_HOST=mariadb MYSQL_DATABASE= MYSQL_USER= MYSQL_PASSWORD= REDIS_HOST=redis REDIS_HOST_PORT=6379 mariadb.env 1 2 3 4 5 MARIADB_ROOT_PASSWORD= MARIADB_DATABASE= MARIADB_USER= MARIADB_PASSWORD= MARIADB_AUTO_UPGRADE=1 docker-compose文件解析 在Nextcloud的官方docker页面https://hub.docker.com/_/nextcloud 有docker-compose的示例配置文件\nnextcloud-fpm Nextcloud中所有的数据文件存放在容器内的/var/www/html中，可以将其映射到外部存储。data和config文件存储在其中单独的文件夹，apps文件夹是随着nextcloud一起提供的，无需在意。\n使用环境变量可以第一次安装时自动配置相关设置，以使用MariaDB/MYSQL为例，配置数据库需要设置以下几个环境变量：\nMYSQL_HOST: Hostname of the database server using mysql / mariadb. MYSQL_DATABASE: Name of the database using mysql / mariadb. MYSQL_USER: Username for the database using mysql / mariadb. MYSQL_PASSWORD: Password for the database user using mysql / mariadb. 设置如下环境变量可以在安装nextcloud时自动配置管理员用户名和密码：\nNEXTCLOUD_ADMIN_USER: Name of the Nextcloud admin user. NEXTCLOUD_ADMIN_PASSWORD: Password for the Nextcloud admin user. 设置如下环境变量可以在安装时自动添加可信域名：\nNEXTCLOUD_TRUSTED_DOMAINS: (not set by default) Optional space-separated list of domains 如果使用了redis（推荐），还应添加下列变量指出redis服务器信息：\nREDIS_HOST (not set by default) Name of Redis container REDIS_HOST_PORT (default: 6379) Optional port for Redis, only use for external Redis servers that run on non-standard ports. REDIS_HOST_PASSWORD (not set by default) Redis password PHP相关限制：（未测试）\nPHP_MEMORY_LIMIT: (default 512M) This sets the maximum amount of memory in bytes that a script is allowed to allocate. This is meant to help prevent poorly written scripts from eating up all available memory but it can prevent normal operation if set too tight. PHP_UPLOAD_LIMIT: (default 512M) This sets the upload limit (post_max_size and upload_max_filesize) for big files. Note that you may have to change other limits depending on your client, webserver or operating system. Check the Nextcloud documentation for more information. 当然，可以使用_FILE替代直接在docke-compose设置环境变量以传递敏感信息。我没仔细看https://hub.docker.com/_/nextcloud\nmariadb mariadb的数据库文件位于容器内的/var/lib/mysql，可以将其映射到容器外部。\n当使用docker创建新数据库时，可以使用以下环境变量来调整MariaDB的初始化，从10.5.10和10.6开始以后的所有版本中，MARIADB_* 和 MYSQL_* 具有等效的功能，且MARIADB_*具有更高的优先级。\n下列四个环境变量(or equivalents, including *_FILE)必须设定一个，以确定roog用户密码：\nMARIADB_ROOT_PASSWORD: This specifies the password that will be set for the MariaDB root superuser account. MARIADB_ROOT_PASSWORD_HASH: In order to have no plaintext secret in the deployment, MARIADB_ROOT_PASSWORD_HASH can be used as it is just the hash of the password. The hash can be generated with SELECT PASSWORD(’thepassword’) as a SQL query. MARIADB_RANDOM_ROOT_PASSWORD: Set to a non-empty value, like yes, to generate a random initial password for the root user. The generated root password will be printed to stdout (GENERATED ROOT PASSWORD: …..). MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: Set to a non-empty value, like yes, to allow the container to be started with a blank password for the root user. 其他的环境变量（可选）：\nMARIADB_DATABASE: This variable allows you to specify the name of a database to be created on image startup. MARIADB_USER: These are used in conjunction to create a new user and to set that user’s password. This user will be granted all access (corresponding to GRANT ALL) to the MARIADB_DATABASE database. MARIADB_PASSWORD: Both user and password variables are required for a user to be created. MARIADB_PASSWORD_HASH: See MARIADB_ROOT_PASSWORD_HASH above for how to get a password hash for MARIADB_PASSWORD_HASH. MARIADB_AUTO_UPGRADE: Set MARIADB_AUTO_UPGRADE to a non-empty value to have the entrypoint check whether mysql_upgrade/mariadb-upgrade needs to run, and if so, run the upgrade before starting the MariaDB server. MARIADB_DISABLE_UPGRADE_BACKUP: Before the upgrade, a backup of the system database is created in the top of the datadir with the name system_mysql_backup_*.sql.zst. This backup process can be disabled with by setting MARIADB_DISABLE_UPGRADE_BACKUP to a non-empty value. nginx 编写配置文件nginx.conf并映射到容器内的/etc/nginx/nginx.conf，作为配置文件；同时还需要把nextcloud中的/var/www/html映射到nginx容器内部，作为网站内容。\nredis cron 官方文档中关于background jons的介绍：https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html\n使用docker部署cron时，cron的运行需要一个独立的容器并和nextcloud共享数据文件，并且据说所占用的内存很少，不会为主机带来性能问题；可以参考官方示例中使用docker-compose运行cron的配置文件：https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/mariadb/apache/docker-compose.yml。\n此外，还可以使用主机的cron并搭配docker exec命令实现定时的后台任务。\n更新nextcloud版本 当使用 docker-compose 时，更新容器的新版本只需要运行:\n1 2 docker-compose pull docker-compose up -d 但是不能跨越多个大版本升级，此时需要修改nextcloud:-fpm指定大版本号进行以此升级。\nnextcloud 配置文件 nextcloud 支持使用多个config.php配置文件；可以在/var/www/html/config/路径下放置*.config.php文件实现对nextcloud的配置，且这些文件中配置的参数优先级高于config.php中的设定。\n1 2 3 4 5 6 \u003c?php $CONFIG = array ( 'remember_login_cookie_lifetime' =\u003e 0, 'default_phone_region' =\u003e 'CN', 'defaultapp' =\u003e 'calendar,files,dashboard', ); remember_login_cookie_lifetime 记住登录 cookie 的生命周期，为0则关闭浏览器后cookie立即失效。\ndefault_phone_region 使用 ISO 3166-1 国家代码为 Nextcloud 服务器上的电话号码设置默认区域。\ndefaultapp 设置用户登录后首先进入的应用；参数为在点击Nextcloud顶部的“应用程序”菜单后，对应的URL名称，如 documents，calendar，gallery等。可以使用\",“分隔应用列表。设置多个应用名称时，如果用户没有进入列表中的第一个应用程序（如列表中的第一个应用没启用），则 Nextcloud 将尝试使用户进入第二个应用程序，依此类推。如果 Nextcloud 没有找到已启用的应用程序，则默认为仪表板应用程序。\nnginx 配置文件 nginx.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 worker_processes auto; error_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid; events { worker_connections 1024; } http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; upstream php-handler { server nextcloud:9000; } server { listen 80; listen [::]:80; #server_name nextcloud.example.com; server_name \u003cexample.domain\u003e; return 301 https://$server_name$request_uri; } server { listen 443 ssl http2; listen [::]:443 ssl http2; #server_name nextcloud.example.com; server_name \u003cexample.domain\u003e; error_page 497 =301 https://$http_host$request_uri; ssl_certificate /etc/ssl/nginx/fullchain.pem; ssl_certificate_key /etc/ssl/nginx/privkey.pem; ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256; ssl_prefer_server_ciphers on; ssl_ecdh_curve secp384r1; # HSTS settings # WARNING: Only add the preload option once you read about # the consequences in https://hstspreload.org/. This option # will add the domain to a hardcoded list that is shipped # in all major browsers and getting removed from this list # could take several months. add_header Strict-Transport-Security \"max-age=15768000; includeSubDomains; preload;\" always; # set max upload size client_max_body_size 100G; fastcgi_buffers 64 4K; fastcgi_send_timeout 300s; fastcgi_read_timeout 300s; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Path to the root of your installation root /usr/share/nginx/html/nextcloud; # Specify how to handle directories -- specifying `/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /index.php$request_uri` # always provides the desired behaviour. index index.php index.html /index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = / { if ( $http_user_agent ~ ^DavClnt ) { return 302 /remote.php/webdav/$is_args$args; } } location = /robots.txt { allow all; log_not_found off; access_log off; } # Make a regex exception for `/.well-known` so that clients can still # access it despite the existence of the regex rule # `location ~ /(\\.|autotest|...)` which would otherwise handle requests # for `/.well-known`. location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 $scheme://$http_host/remote.php/dav/; } location = /.well-known/caldav { return 301 $scheme://$http_host/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 $scheme://$http_host/index.php$request_uri; } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends `/index.php` # to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; # fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; #fastcgi_param HTTPS on; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass php-handler; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif)$ { try_files $uri /index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /remote { return 301 /remote.php$request_uri; } location / { try_files $uri $uri/ /index.php$request_uri; } } } root /usr/share/nginx/html/nextcloud; 设置了网站的根目录位置；需要通过docker-compose把nextcloud中的/var/www/html映射到 root … 设置的路径下。\nfastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name; 用来配置fastcgi传递nginx到php-fpm的信息，/var/www/html 需要设定为nextcloud容器中网站的路径；若nginx中的网站路径使用 root … 设定为与nextcloud中路径相同(/var/www/html)，则可以使用 $document_root 代替 /var/www/html。\nMariaDB 10.6兼容性问题 nextcloud25已无此问题。\nnextcloud22和mariadb10.6有兼容性问题，对docker-compose文件中mariadb的command添加–innodb_read_only_compressed=OFF可暂时解决。\nhttps://github.com/nextcloud/server/issues/25436\nnextcloud 维护模式 1 2 3 cd /var/www/nextcloud sudo -u www-data php occ maintenance:mode --on sudo -u www-data php occ maintenance:mode --off ",
  "wordCount" : "4046",
  "inLanguage": "zh-cn",
  "datePublished": "2022-12-20T11:05:07+08:00",
  "dateModified": "2022-12-20T11:05:07+08:00",
  "author":{
    "@type": "Person",
    "name": "hey"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fivekernels.github.io/posts/nextcloud-with-docker/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "胡写乱画",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fivekernels.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fivekernels.github.io/" accesskey="h" title="胡写乱画 (Alt + H)">胡写乱画</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fivekernels.github.io/" title="🏠首页">
                    <span>🏠首页</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/posts/" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/categories/" title="🧩分类">
                    <span>🧩分类</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/tags/" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/about/" title="🥣关于">
                    <span>🥣关于</span>
                </a>
            </li>
            <li>
                <a href="https://fivekernels.github.io/search/" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fivekernels.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://fivekernels.github.io/posts/">📚文章</a></div>
    <h1 class="post-title">
      Nextcloud With Docker<sup><span class="entry-isdraft">&nbsp;&nbsp;[draft]</span></sup>
    </h1>
    <div class="post-meta">



<span title='2022-12-20 11:05:07 +0800 CST'>2022/12/20</span>&nbsp;·&nbsp;Updated:&nbsp;2022/12/20&nbsp;·&nbsp;9 min&nbsp;·&nbsp;4046 words&nbsp;·&nbsp;hey

</div>
  </header> 
  <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#docker-compose" aria-label="docker-compose">docker-compose</a><ul>
                            
                    <li>
                        <a href="#docker-composeyml" aria-label="docker-compose.yml">docker-compose.yml</a></li>
                    <li>
                        <a href="#nextcloudenv" aria-label="nextcloud.env">nextcloud.env</a></li>
                    <li>
                        <a href="#mariadbenv" aria-label="mariadb.env">mariadb.env</a></li></ul>
                    </li>
                    <li>
                        <a href="#docker-compose%e6%96%87%e4%bb%b6%e8%a7%a3%e6%9e%90" aria-label="docker-compose文件解析">docker-compose文件解析</a><ul>
                            
                    <li>
                        <a href="#nextcloud-fpm" aria-label="nextcloud-fpm">nextcloud-fpm</a></li>
                    <li>
                        <a href="#mariadb" aria-label="mariadb">mariadb</a></li>
                    <li>
                        <a href="#nginx" aria-label="nginx">nginx</a></li>
                    <li>
                        <a href="#redis" aria-label="redis">redis</a></li>
                    <li>
                        <a href="#cron" aria-label="cron">cron</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%9b%b4%e6%96%b0nextcloud%e7%89%88%e6%9c%ac" aria-label="更新nextcloud版本">更新nextcloud版本</a></li>
                    <li>
                        <a href="#nextcloud-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="nextcloud 配置文件">nextcloud 配置文件</a></li>
                    <li>
                        <a href="#nginx-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="nginx 配置文件">nginx 配置文件</a><ul>
                            
                    <li>
                        <a href="#nginxconf" aria-label="nginx.conf">nginx.conf</a></li></ul>
                    </li>
                    <li>
                        <a href="#mariadb-106%e5%85%bc%e5%ae%b9%e6%80%a7%e9%97%ae%e9%a2%98" aria-label="MariaDB 10.6兼容性问题"><del>MariaDB 10.6兼容性问题</del></a></li>
                    <li>
                        <a href="#nextcloud-%e7%bb%b4%e6%8a%a4%e6%a8%a1%e5%bc%8f" aria-label="nextcloud 维护模式">nextcloud 维护模式</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><p>  本文介绍了在树莓派(aarch64)上使用docker的方式配置nextcloud:fpm、mariadb、nginx、redis以及onlyoffice。</p>
<p>  Nextcloud官方手册中有数据库等各种镜像版本推荐<a href="https://docs.nextcloud.com/server/latest/admin_manual/installation/system_requirements.html">https://docs.nextcloud.com/server/latest/admin_manual/installation/system_requirements.html</a>，最好不要使用过于新的版本以免出现未被解决的兼容性问题。</p>
<p><strong>Nextcloud版本介绍：</strong></p>
<ul>
<li>nextcloud:latest：默认最新版本，新手友好。使用debian容器搭建，自带apache web服务，特点就是简单方便，一键部署就可以使用，缺点就是包略大。</li>
<li>nextcloud:fpm：在debian容器的基础上不带apache web服务，需要配套web程序才能使用，如NGINX。</li>
<li>nextcloud:&lt;version&gt;-alpine：使用alpine作为容器，空间占据少，适合小主机使用。</li>
</ul>
<h2 id="docker-compose">docker-compose<a hidden class="anchor" aria-hidden="true" href="#docker-compose">#</a></h2>
<h3 id="docker-composeyml">docker-compose.yml<a hidden class="anchor" aria-hidden="true" href="#docker-composeyml">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nextcloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud:fpm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud_nextcloud</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./PersistentData/nextcloud:/var/www/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./nextcloud.env</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">mariadb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mariadb</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">mariadb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mariadb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud_mariadb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span>--<span class="l">character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --transaction-isolation=READ-COMMITTED --binlog-format=ROW  --innodb_read_only_compressed=OFF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./PersistentData/mariadb:/var/lib/mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./mariadb.env</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud_nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span><span class="w">
</span></span></span><span class="line hl"><span class="cl"><span class="w">            </span>- <span class="l">./config/ssl/&lt;example.domain&gt;/fullchain.pem:/etc/ssl/nginx/fullchain.pem</span><span class="w">
</span></span></span><span class="line hl"><span class="cl"><span class="w">            </span>- <span class="l">./config/ssl/&lt;example.domain&gt;/privkey.pem:/etc/ssl/nginx/privkey.pem</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./PersistentData/nextcloud:/usr/share/nginx/html/nextcloud:ro</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;80:80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;443:443&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">nextcloud</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud_redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cron</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud:fpm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nextcloud_cron</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">./PersistentData/nextcloud:/var/www/html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">/cron.sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">mariadb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">redis</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nextcloudenv">nextcloud.env<a hidden class="anchor" aria-hidden="true" href="#nextcloudenv">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt"> 1
</span></span><span class="hl"><span class="lnt"> 2
</span></span><span class="hl"><span class="lnt"> 3
</span></span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="hl"><span class="lnt"> 7
</span></span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line hl"><span class="cl">NEXTCLOUD_ADMIN_USER=&lt;nextcloud_admin_user_to_be_created&gt;
</span></span><span class="line hl"><span class="cl">NEXTCLOUD_ADMIN_PASSWORD=&lt;nextcloud_admin_user_password_to_be_created&gt;
</span></span><span class="line hl"><span class="cl">NEXTCLOUD_TRUSTED_DOMAINS=&lt;example.domain&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MYSQL_HOST=mariadb
</span></span><span class="line hl"><span class="cl">MYSQL_DATABASE=&lt;nextcloud_database_to_be_used&gt;
</span></span><span class="line hl"><span class="cl">MYSQL_USER=&lt;nextcloud_database_user_to_be_used&gt;
</span></span><span class="line hl"><span class="cl">MYSQL_PASSWORD=&lt;nextcloud_database_user_password_to_be_used&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">REDIS_HOST=redis
</span></span><span class="line"><span class="cl">REDIS_HOST_PORT=6379
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mariadbenv">mariadb.env<a hidden class="anchor" aria-hidden="true" href="#mariadbenv">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt">1
</span></span><span class="hl"><span class="lnt">2
</span></span><span class="hl"><span class="lnt">3
</span></span><span class="hl"><span class="lnt">4
</span></span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line hl"><span class="cl">MARIADB_ROOT_PASSWORD=&lt;root_password&gt;
</span></span><span class="line hl"><span class="cl">MARIADB_DATABASE=&lt;nextcloud_database_to_be_created&gt;
</span></span><span class="line hl"><span class="cl">MARIADB_USER=&lt;nextcloud_database_user_to_be_created&gt;
</span></span><span class="line hl"><span class="cl">MARIADB_PASSWORD=&lt;nextcloud_database_user_password_to_be_created&gt;
</span></span><span class="line"><span class="cl">MARIADB_AUTO_UPGRADE=1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="docker-compose文件解析">docker-compose文件解析<a hidden class="anchor" aria-hidden="true" href="#docker-compose文件解析">#</a></h2>
<p>  在Nextcloud的官方docker页面<a href="https://hub.docker.com/_/nextcloud">https://hub.docker.com/_/nextcloud</a> 有docker-compose的示例配置文件</p>
<h3 id="nextcloud-fpm">nextcloud-fpm<a hidden class="anchor" aria-hidden="true" href="#nextcloud-fpm">#</a></h3>
<p>  Nextcloud中所有的数据文件存放在容器内的/var/www/html中，可以将其映射到外部存储。data和config文件存储在其中单独的文件夹，apps文件夹是随着nextcloud一起提供的，无需在意。</p>
<p>  使用环境变量可以第一次安装时自动配置相关设置，以使用MariaDB/MYSQL为例，配置数据库需要设置以下几个环境变量：</p>
<ul>
<li>MYSQL_HOST: Hostname of the database server using mysql / mariadb.</li>
<li>MYSQL_DATABASE: Name of the database using mysql / mariadb.</li>
<li>MYSQL_USER: Username for the database using mysql / mariadb.</li>
<li>MYSQL_PASSWORD: Password for the database user using mysql / mariadb.</li>
</ul>
<p>  设置如下环境变量可以在安装nextcloud时自动配置管理员用户名和密码：</p>
<ul>
<li>NEXTCLOUD_ADMIN_USER: Name of the Nextcloud admin user.</li>
<li>NEXTCLOUD_ADMIN_PASSWORD: Password for the Nextcloud admin user.</li>
</ul>
<p>  设置如下环境变量可以在安装时自动添加可信域名：</p>
<ul>
<li>NEXTCLOUD_TRUSTED_DOMAINS: (not set by default) Optional space-separated list of domains</li>
</ul>
<p>  如果使用了redis（推荐），还应添加下列变量指出redis服务器信息：</p>
<ul>
<li>REDIS_HOST (not set by default) Name of Redis container</li>
<li>REDIS_HOST_PORT (default: 6379) Optional port for Redis, only use for external Redis servers that run on non-standard ports.</li>
<li>REDIS_HOST_PASSWORD (not set by default) Redis password</li>
</ul>
<p>  PHP相关限制：（未测试）</p>
<ul>
<li>PHP_MEMORY_LIMIT: (default 512M) This sets the maximum amount of memory in bytes that a script is allowed to allocate. This is meant to help prevent poorly written scripts from eating up all available memory but it can prevent normal operation if set too tight.</li>
<li>PHP_UPLOAD_LIMIT: (default 512M) This sets the upload limit (<em>post_max_size</em> and <em>upload_max_filesize</em>) for big files. Note that you may have to change other limits depending on your client, webserver or operating system. Check the <a href="https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/big_file_upload_configuration.html">Nextcloud documentation</a> for more information.</li>
</ul>
<p>  当然，可以使用_FILE替代直接在docke-compose设置环境变量以传递敏感信息。我没仔细看<a href="https://hub.docker.com/_/nextcloud">https://hub.docker.com/_/nextcloud</a></p>
<h3 id="mariadb">mariadb<a hidden class="anchor" aria-hidden="true" href="#mariadb">#</a></h3>
<p>  mariadb的数据库文件位于容器内的/var/lib/mysql，可以将其映射到容器外部。</p>
<p>  当使用docker创建新数据库时，可以使用以下环境变量来调整MariaDB的初始化，从10.5.10和10.6开始以后的所有版本中，MARIADB_* 和 MYSQL_* 具有等效的功能，且MARIADB_*具有更高的优先级。</p>
<p>  下列四个环境变量(or equivalents, including *_FILE)必须设定一个，以确定roog用户密码：</p>
<ul>
<li>MARIADB_ROOT_PASSWORD: This specifies the password that will be set for the MariaDB root superuser account.</li>
<li>MARIADB_ROOT_PASSWORD_HASH: In order to have no plaintext secret in the deployment, MARIADB_ROOT_PASSWORD_HASH can be used as it is just the hash of the password. The hash can be generated with SELECT PASSWORD(&rsquo;thepassword&rsquo;) as a SQL query.</li>
<li>MARIADB_RANDOM_ROOT_PASSWORD: Set to a non-empty value, like yes, to generate a random initial password for the root user. The generated root password will be printed to stdout (GENERATED ROOT PASSWORD: &hellip;..).</li>
<li>MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: Set to a non-empty value, like yes, to allow the container to be started with a blank password for the root user.</li>
</ul>
<p>  其他的环境变量（可选）：</p>
<ul>
<li>MARIADB_DATABASE: This variable allows you to specify the name of a database to be created on image startup.</li>
<li>MARIADB_USER: These are used in conjunction to create a new user and to set that user&rsquo;s password. This user will be granted all access (corresponding to GRANT ALL) to the MARIADB_DATABASE database.</li>
<li>MARIADB_PASSWORD: Both user and password variables are required for a user to be created.</li>
<li>MARIADB_PASSWORD_HASH: See MARIADB_ROOT_PASSWORD_HASH above for how to get a password hash for MARIADB_PASSWORD_HASH.</li>
<li>MARIADB_AUTO_UPGRADE: Set MARIADB_AUTO_UPGRADE to a non-empty value to have the entrypoint check whether mysql_upgrade/mariadb-upgrade needs to run, and if so, run the upgrade before starting the MariaDB server.</li>
<li>MARIADB_DISABLE_UPGRADE_BACKUP: Before the upgrade, a backup of the system database is created in the top of the datadir with the name system_mysql_backup_*.sql.zst. This backup process can be disabled with by setting MARIADB_DISABLE_UPGRADE_BACKUP to a non-empty value.</li>
</ul>
<h3 id="nginx">nginx<a hidden class="anchor" aria-hidden="true" href="#nginx">#</a></h3>
<p>  编写配置文件nginx.conf并映射到容器内的/etc/nginx/nginx.conf，作为配置文件；同时还需要把nextcloud中的/var/www/html映射到nginx容器内部，作为网站内容。</p>
<h3 id="redis">redis<a hidden class="anchor" aria-hidden="true" href="#redis">#</a></h3>
<h3 id="cron">cron<a hidden class="anchor" aria-hidden="true" href="#cron">#</a></h3>
<p>  官方文档中关于background jons的介绍：<a href="https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html">https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html</a></p>
<p>  使用docker部署cron时，<a href="https://github.com/nextcloud/docker/issues/1695#issuecomment-1043169925">cron的运行需要一个独立的容器并和nextcloud共享数据文件，并且据说所占用的内存很少，不会为主机带来性能问题</a>；可以参考官方示例中使用docker-compose运行cron的配置文件：<a href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/mariadb/apache/docker-compose.yml">https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/mariadb/apache/docker-compose.yml</a>。</p>
<p>  此外，还可以使用主机的cron并搭配docker exec命令实现定时的后台任务。</p>
<h2 id="更新nextcloud版本">更新nextcloud版本<a hidden class="anchor" aria-hidden="true" href="#更新nextcloud版本">#</a></h2>
<p>  当使用 docker-compose 时，更新容器的新版本只需要运行:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker-compose pull
</span></span><span class="line"><span class="cl">docker-compose up -d
</span></span></code></pre></td></tr></table>
</div>
</div><p>  但是不能跨越多个大版本升级，此时需要修改nextcloud:&lt;version&gt;-fpm指定大版本号进行以此升级。</p>
<h2 id="nextcloud-配置文件">nextcloud 配置文件<a hidden class="anchor" aria-hidden="true" href="#nextcloud-配置文件">#</a></h2>
<p>  nextcloud 支持使用多个config.php配置文件；可以在/var/www/html/config/路径下放置*.config.php文件实现对nextcloud的配置，且这些文件中配置的参数优先级高于config.php中的设定。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CONFIG</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;remember_login_cookie_lifetime&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;default_phone_region&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;CN&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;defaultapp&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;calendar,files,dashboard&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>  <em><strong>remember_login_cookie_lifetime</strong></em> 记住登录 cookie 的生命周期，为0则关闭浏览器后cookie立即失效。<br>
  <em><strong>default_phone_region</strong></em> 使用 ISO 3166-1 国家代码为 Nextcloud 服务器上的电话号码设置默认区域。<br>
  <em><strong>defaultapp</strong></em> 设置用户登录后首先进入的应用；参数为在点击Nextcloud顶部的“应用程序”菜单后，对应的URL名称，如 documents，calendar，gallery等。可以使用&quot;,&ldquo;分隔应用列表。设置多个应用名称时，如果用户没有进入列表中的第一个应用程序（如列表中的第一个应用没启用），则 Nextcloud 将尝试使用户进入第二个应用程序，依此类推。如果 Nextcloud 没有找到已启用的应用程序，则默认为仪表板应用程序。</p>
<h2 id="nginx-配置文件">nginx 配置文件<a hidden class="anchor" aria-hidden="true" href="#nginx-配置文件">#</a></h2>
<h3 id="nginxconf">nginx.conf<a hidden class="anchor" aria-hidden="true" href="#nginxconf">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="hl"><span class="lnt"> 35
</span></span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="hl"><span class="lnt"> 44
</span></span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="hl"><span class="lnt"> 96
</span></span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="hl"><span class="lnt">157
</span></span><span class="hl"><span class="lnt">158
</span></span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">worker_processes</span><span class="w">  </span><span class="n">auto</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">error_log</span><span class="w">  </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="n">warn</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pid</span><span class="w">        </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">events</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">worker_connections</span><span class="w">  </span><span class="mi">1024</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">http</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">include</span><span class="w">       </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">mime</span><span class="p">.</span><span class="n">types</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">default_type</span><span class="w">  </span><span class="n">application</span><span class="o">/</span><span class="n">octet</span><span class="o">-</span><span class="n">stream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log_format</span><span class="w">  </span><span class="n">main</span><span class="w">  </span><span class="s1">&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="s1">&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="s1">&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">access_log</span><span class="w">  </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">access</span><span class="p">.</span><span class="n">log</span><span class="w">  </span><span class="n">main</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sendfile</span><span class="w">        </span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">#tcp_nopush     on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">keepalive_timeout</span><span class="w">  </span><span class="mi">65</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">#gzip  on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">upstream</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">handler</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="n">nextcloud</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="p">[::]:</span><span class="mi">80</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">#server_name nextcloud.example.com;
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">server_name</span><span class="w"> </span><span class="o">&lt;</span><span class="n">example</span><span class="p">.</span><span class="n">domain</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">server_name</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="k">ssl</span><span class="w"> </span><span class="n">http2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="p">[::]:</span><span class="mi">443</span><span class="w"> </span><span class="k">ssl</span><span class="w"> </span><span class="n">http2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">#server_name nextcloud.example.com;
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">server_name</span><span class="w"> </span><span class="o">&lt;</span><span class="n">example</span><span class="p">.</span><span class="n">domain</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">error_page</span><span class="w"> </span><span class="mi">497</span><span class="w"> </span><span class="o">=</span><span class="mi">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">http_host</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_certificate</span><span class="w">     </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fullchain</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">privkey</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_protocols</span><span class="w">             </span><span class="n">TLSv1</span><span class="w"> </span><span class="n">TLSv1</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="n">TLSv1</span><span class="p">.</span><span class="mi">2</span><span class="w"> </span><span class="n">TLSv1</span><span class="p">.</span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_ciphers</span><span class="w">               </span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ssl_ecdh_curve</span><span class="w">            </span><span class="n">secp384r1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># HSTS settings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># WARNING: Only add the preload option once you read about
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># the consequences in https://hstspreload.org/. This option
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># will add the domain to a hardcoded list that is shipped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># in all major browsers and getting removed from this list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># could take several months.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w"> </span><span class="s2">&#34;max-age=15768000; includeSubDomains; preload;&#34;</span><span class="w"> </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># set max upload size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">client_max_body_size</span><span class="w"> </span><span class="mi">100</span><span class="n">G</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fastcgi_buffers</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="mi">4</span><span class="n">K</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fastcgi_send_timeout</span><span class="w"> </span><span class="mi">300</span><span class="n">s</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fastcgi_read_timeout</span><span class="w"> </span><span class="mi">300</span><span class="n">s</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Enable gzip but do not remove ETag headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">gzip</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">gzip_vary</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">gzip_comp_level</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">gzip_min_length</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">gzip_proxied</span><span class="w"> </span><span class="n">expired</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="n">no</span><span class="o">-</span><span class="n">store</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">no_last_modified</span><span class="w"> </span><span class="n">no_etag</span><span class="w"> </span><span class="n">auth</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">gzip_types</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">atom</span><span class="o">+</span><span class="n">xml</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">javascript</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">ld</span><span class="o">+</span><span class="n">json</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">manifest</span><span class="o">+</span><span class="n">json</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">rss</span><span class="o">+</span><span class="n">xml</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">geo</span><span class="o">+</span><span class="n">json</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">ms</span><span class="o">-</span><span class="n">fontobject</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">font</span><span class="o">-</span><span class="n">ttf</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">manifest</span><span class="o">+</span><span class="n">json</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">xhtml</span><span class="o">+</span><span class="n">xml</span><span class="w"> </span><span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="w"> </span><span class="n">font</span><span class="o">/</span><span class="n">opentype</span><span class="w"> </span><span class="n">image</span><span class="o">/</span><span class="n">bmp</span><span class="w"> </span><span class="n">image</span><span class="o">/</span><span class="n">svg</span><span class="o">+</span><span class="n">xml</span><span class="w"> </span><span class="n">image</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">icon</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">cache</span><span class="o">-</span><span class="n">manifest</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">css</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">plain</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">vcard</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">rim</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">xloc</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">vtt</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">component</span><span class="w"> </span><span class="kt">text</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="k">cross</span><span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">policy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Pagespeed is not supported by Nextcloud, so if your server is built
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># with the `ngx_pagespeed` module, uncomment this line to disable it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">#pagespeed off;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># HTTP response headers borrowed from Nextcloud `.htaccess`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">Referrer</span><span class="o">-</span><span class="n">Policy</span><span class="w">                      </span><span class="s2">&#34;no-referrer&#34;</span><span class="w">   </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="n">Options</span><span class="w">               </span><span class="s2">&#34;nosniff&#34;</span><span class="w">       </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Download</span><span class="o">-</span><span class="n">Options</span><span class="w">                   </span><span class="s2">&#34;noopen&#34;</span><span class="w">        </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="w">                      </span><span class="s2">&#34;SAMEORIGIN&#34;</span><span class="w">    </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Permitted</span><span class="o">-</span><span class="k">Cross</span><span class="o">-</span><span class="n">Domain</span><span class="o">-</span><span class="n">Policies</span><span class="w">    </span><span class="s2">&#34;none&#34;</span><span class="w">          </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Robots</span><span class="o">-</span><span class="n">Tag</span><span class="w">                         </span><span class="s2">&#34;none&#34;</span><span class="w">          </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">XSS</span><span class="o">-</span><span class="n">Protection</span><span class="w">                     </span><span class="s2">&#34;1; mode=block&#34;</span><span class="w"> </span><span class="n">always</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Remove X-Powered-By, which is an information leak
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">fastcgi_hide_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="k">By</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Path to the root of your installation
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">nextcloud</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Specify how to handle directories -- specifying `/index.php$request_uri`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># here as the fallback means that Nginx always exhibits the desired behaviour
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># when a client requests a path that corresponds to a directory that exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># on the server. In particular, if that directory contains an index.php file,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># that file is correctly served; if it doesn&#39;t, then the request is passed to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># the front-end controller. This consistent behaviour means that we don&#39;t need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># to specify custom rules for certain paths (e.g. images and other assets,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># `/updater`, `/ocm-provider`, `/ocs-provider`), and thus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># `try_files $uri $uri/ /index.php$request_uri`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># always provides the desired behaviour.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">index</span><span class="w"> </span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="w"> </span><span class="k">index</span><span class="p">.</span><span class="n">html</span><span class="w"> </span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Rule borrowed from `.htaccess` to handle Microsoft DAV clients
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">$</span><span class="n">http_user_agent</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^</span><span class="n">DavClnt</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="o">/</span><span class="n">remote</span><span class="p">.</span><span class="n">php</span><span class="o">/</span><span class="n">webdav</span><span class="o">/</span><span class="err">$</span><span class="n">is_args</span><span class="err">$</span><span class="n">args</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">robots</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">allow</span><span class="w"> </span><span class="k">all</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Make a regex exception for `/.well-known` so that clients can still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># access it despite the existence of the regex rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># `location ~ /(\.|autotest|...)` which would otherwise handle requests
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># for `/.well-known`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">^~</span><span class="w"> </span><span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1"># The rules in this block are an adaptation of the rules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1"># in `.htaccess` that concern `/.well-known`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">carddav</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">http_host</span><span class="o">/</span><span class="n">remote</span><span class="p">.</span><span class="n">php</span><span class="o">/</span><span class="n">dav</span><span class="o">/</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">caldav</span><span class="w">  </span><span class="err">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">http_host</span><span class="o">/</span><span class="n">remote</span><span class="p">.</span><span class="n">php</span><span class="o">/</span><span class="n">dav</span><span class="o">/</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span><span class="w">    </span><span class="err">{</span><span class="w"> </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">pki</span><span class="o">-</span><span class="n">validation</span><span class="w">    </span><span class="err">{</span><span class="w"> </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1"># Let Nextcloud&#39;s API for `/.well-known` URIs handle all other
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1"># requests by passing them to the front-end controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">http_host</span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Rules borrowed from `.htaccess` to hide certain paths from clients
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="o">?</span><span class="p">:</span><span class="n">build</span><span class="o">|</span><span class="n">tests</span><span class="o">|</span><span class="n">config</span><span class="o">|</span><span class="n">lib</span><span class="o">|</span><span class="mi">3</span><span class="n">rdparty</span><span class="o">|</span><span class="n">templates</span><span class="o">|</span><span class="n">data</span><span class="p">)(</span><span class="o">?</span><span class="p">:</span><span class="err">$</span><span class="o">|/</span><span class="p">)</span><span class="w">  </span><span class="err">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="o">?</span><span class="p">:</span><span class="err">\</span><span class="p">.</span><span class="o">|</span><span class="n">autotest</span><span class="o">|</span><span class="n">occ</span><span class="o">|</span><span class="n">issue</span><span class="o">|</span><span class="n">indie</span><span class="o">|</span><span class="n">db_</span><span class="o">|</span><span class="n">console</span><span class="p">)</span><span class="w">                </span><span class="err">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Ensure this block, which passes PHP files to the PHP process, is above the blocks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># which handle static assets (as seen below). If this block is not declared first,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># then Nginx will encounter an infinite rewriting loop when it prepends `/index.php`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1"># to the URI, resulting in a HTTP 500 error response.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="err">\</span><span class="p">.</span><span class="nf">php</span><span class="p">(</span><span class="o">?</span><span class="p">:</span><span class="err">$</span><span class="o">|/</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fastcgi_split_path_info</span><span class="w"> </span><span class="o">^</span><span class="p">(.</span><span class="o">+?</span><span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="p">)(</span><span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">set</span><span class="w"> </span><span class="err">$</span><span class="n">path_info</span><span class="w"> </span><span class="err">$</span><span class="n">fastcgi_path_info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span><span class="w">
</span></span></span><span class="line hl"><span class="cl"><span class="w">            </span><span class="c1"># fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">SCRIPT_FILENAME</span><span class="w"> </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="err">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">PATH_INFO</span><span class="w"> </span><span class="err">$</span><span class="n">path_info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">#fastcgi_param HTTPS on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">modHeadersAvailable</span><span class="w"> </span><span class="no">true</span><span class="p">;</span><span class="w">         </span><span class="c1"># Avoid sending the security headers twice
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">front_controller_active</span><span class="w"> </span><span class="no">true</span><span class="p">;</span><span class="w">     </span><span class="c1"># Enable pretty urls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">handler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fastcgi_intercept_errors</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fastcgi_request_buffering</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="err">\</span><span class="p">.(</span><span class="o">?</span><span class="p">:</span><span class="n">css</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">svg</span><span class="o">|</span><span class="n">gif</span><span class="p">)</span><span class="err">$</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">expires</span><span class="w"> </span><span class="mi">6</span><span class="n">M</span><span class="p">;</span><span class="w">         </span><span class="c1"># Cache-Control policy borrowed from `.htaccess`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w">     </span><span class="c1"># Optional: Don&#39;t log access to assets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="err">\</span><span class="p">.</span><span class="n">woff2</span><span class="o">?</span><span class="err">$</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">expires</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="p">;</span><span class="w">         </span><span class="c1"># Cache-Control policy borrowed from `.htaccess`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w">     </span><span class="c1"># Optional: Don&#39;t log access to assets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># Rule borrowed from `.htaccess`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">remote</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="o">/</span><span class="n">remote</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="err">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>  <em><strong>root /usr/share/nginx/html/nextcloud;</strong></em> 设置了网站的根目录位置；需要通过docker-compose把nextcloud中的/var/www/html映射到 <em>root &hellip;</em> 设置的路径下。</p>
<p>  <em><strong>fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;</strong></em> 用来配置fastcgi传递nginx到php-fpm的信息，<em>/var/www/html</em> 需要设定为nextcloud容器中网站的路径；若nginx中的网站路径使用 <em>root &hellip;</em> 设定为与nextcloud中路径相同(<em>/var/www/html</em>)，则可以使用  <em>$document_root</em> 代替 <em>/var/www/html</em>。</p>
<h2 id="mariadb-106兼容性问题"><del>MariaDB 10.6兼容性问题</del><a hidden class="anchor" aria-hidden="true" href="#mariadb-106兼容性问题">#</a></h2>
<p>  nextcloud25已无此问题。<br>
  nextcloud22和mariadb10.6有兼容性问题，对docker-compose文件中mariadb的command添加&ndash;innodb_read_only_compressed=OFF可暂时解决。</p>
<p><a href="https://github.com/nextcloud/server/issues/25436">https://github.com/nextcloud/server/issues/25436</a></p>
<h2 id="nextcloud-维护模式">nextcloud 维护模式<a hidden class="anchor" aria-hidden="true" href="#nextcloud-维护模式">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /var/www/nextcloud
</span></span><span class="line"><span class="cl">sudo -u www-data php occ maintenance:mode --on
</span></span><span class="line"><span class="cl">sudo -u www-data php occ maintenance:mode --off
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://fivekernels.github.io/tags/nextcloud/">nextcloud</a></li>
      <li><a href="https://fivekernels.github.io/tags/docker/">docker</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://fivekernels.github.io/posts/openwrt-configuration/">
    <span class="title">« </span>
    <br>
    <span>OpenWrt Configuration</span>
  </a>
  <a class="next" href="https://fivekernels.github.io/posts/stm32-systick-ll/">
    <span class="title"> »</span>
    <br>
    <span>STM32 SysTick LL</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://fivekernels.github.io/">胡写乱画</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
